#! /bin/bash
# remove all the contents in students' feedback folder
read -p 'Please enter target folder name: ' folder

DIR="$HOME/Desktop/$folder"
SUB="Submission attachment(s)"
FED="Feedback Attachment(s)"

# total holds the total num of the students
total=$(ls -l $DIR | grep -c -e "^d")


bar="##############################" # 30
barlen=${#bar}
n=0

remove() {
  for item in *; do
    # check if the item is a dir
    if [ -d "$item" ]; then
      # count as one student if item is a directory
      # total+=("$item")

      # check if empty, i.e either empty or mere a .DS_Store file
      if [[ "$(ls -A "$item"/"$SUB" | wc -l)" -eq 0 \
        || "$(ls -A "$item"/"$SUB")" == ".DS_Store" ]]; then
      # if empty
      # empty array to hold students who submit nothing   
        empty+=("$item")
      # if not empty  
      else
        rm -rf "$item"/"$FED"/*
        load+=("$item")
        # printf "\r[%-${barlen}s]" "${bar:0:++n}"
        # sleep 0.1
      fi
    else
      # if not a dir, do nothing
      continue
    fi
  done
  # count=0
  # while ((count<=30)); do
  #   # bash supports only integer; make sure n increases in one each time
  #   n=$((count*barlen / 30)) # 0 1 2 3 4 5 
  #   printf "\r[%-${barlen}s]" "${bar:0:n}"
  #   count=$(( count + 1))
  #   sleep 0.1
  # done
  echo
}

# start processing
printf "\e[0;33m%s\e[0m\n" "Start Deleting ..."
cd ${DIR}
remove
cd $HOME/Desktop

printf "\e[0;32m%s\e[0m\n" "Deleting DONE!"
echo
printf "\e[1;32m%d\e[0m students in total.\n" $total
printf "\e[1;33m%d\e[0m students got feedback.\n" ${#load[@]}
printf "\e[1;31m%d\e[0m students submitted nothing.\n" ${#empty[@]}

echo
if [ ${#empty[@]} -gt 0 ]; then
    declare -a name
    declare -a netid
    pat='([a-zA-Z ,]+)\(([a-z0-9]+)\)'
  for i in "${empty[@]}"; do
    [[ "$i" =~ $pat ]] 
	name+=("${BASH_REMATCH[1]}")
	netid+=("${BASH_REMATCH[2]}")	
  done
fi

printf "The following students have \e[1;36m%s\e[0m submission.\n" "NO"
printf "\e[0;34m%-10s\e[0m\t\e[0;34m%-40s\e[0m\n" "NetID" "Student Name"
for ((i = 0; i < ${#name[@]}; ++i)); do
   printf "%-10s\t%-35s\n" "${netid[i]}" "${name[i]}"
done
unset empty load total count
